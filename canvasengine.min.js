/*!
 * Canvas Engine JavaScript Library 1.3.0
 * http:/canvasengine.net
 *
 * Copyright 2012, WebCreative5, Samuel Ronce
 * Licensed under the MIT.
 *
 * Date: September 14, 2012
 * Update : Fri Sep 27 12:12:14 2013
 */
var fs;if(typeof(require)!=="undefined"){fs=require("fs")}function Kernel(b,a){this.class_method=b;this.class_name=a}Kernel._extend=function(a,b,g){var f;if(!(b instanceof Array)){b=[b]}for(var e=0;e<b.length;e++){g=g===undefined?true:g;f=b[e];if(typeof f=="string"){if(Class.__class_config[f]){f=Class.__class_config[f].methods}else{return a}}if(g){f=CanvasEngine.clone(f)}for(var d in f){a[d]=f[d]}}return a};Kernel.prototype={New:function(){return this["new"].apply(this,arguments)},"new":function(){this._class=new Class();Class.__class[this.class_name]=this._class;this._construct();return this._class},_construct:function(){this._class.extend(this.class_method)},_attr_accessor:function(d,a,f){var b=this;for(var e=0;e<d.length;e++){this.class_method["_"+d[e]]=null;this.class_method[d[e]]={};if(a){this.class_method[d[e]].set=function(g){b.class_method["_"+d[e]]=g}}if(f){this.class_method[d[e]].get=function(){return b.class_method["_"+d[e]]}}}return this},attr_accessor:function(a){return this._attr_accessor(a,true,true)},attr_reader:function(a){return this._attr_accessor(a,true,false)},attr_writer:function(a){return this._attr_accessor(a,false,true)},extend:function(a,b){Kernel._extend(this.class_method,a,b);return this},addIn:function(a){if(!Class.__class[a]){return this}Class.__class[a][this.name]=this;return this}};function Class(){this.name=null}Class.__class={};Class.__class_config={};Class.get=function(a){return Class.__class[a]};Class.create=function(e,d,h){var g,b,a;Class.__class_config[e]={};Class.__class[e]={};if(h){g=window[e];tmp_class=new Class();for(var f in tmp_class){g[f]=tmp_class[f]}for(var f in d){g[f]=d[f]}b=g}else{Class.__class_config[e].methods=d;var i=Class.__class_config[e].kernel=new Kernel(Class.__class_config[e].methods,e)}return i};Class.New=function(){return Class["new"].apply(this,arguments)};Class["new"]=function(d,e,a){var b;if(typeof e=="boolean"){a=e;e=[]}if(a==undefined){a=true}e=e||[];if(!Class.__class_config[d]){throw d+' class does not exist. Use method "create" for build the structure of this class'}b=Class.__class_config[d].kernel["new"]();if(a&&b.initialize){b.initialize.apply(b,e)}b.__name__=d;return b};Class.prototype={extend:function(a,b){return Kernel._extend(this,a,b)}};var CanvasEngine={};CanvasEngine.uniqid=function(){return Math.random()};CanvasEngine.arraySplice=function(b,d){var a;for(a=0;a<d.length;++a){if(b==d[a]){d.splice(a,1);return}}};CanvasEngine.ajax=function(a){a=CanvasEngine.extend({url:"./",type:"GET",statusCode:{}},a);a.data=a.data?JSON.stringify(a.data):null;if(fs){fs.readFile("./"+a.url,"ascii",function(i,e){if(i){throw i}e=e.toString("ascii");if(a.dataType=="json"){e=CanvasEngine.parseJSON(e)}a.success(e)});return}var h;try{h=new ActiveXObject("Msxml2.XMLHTTP")}catch(f){try{h=new ActiveXObject("Microsoft.XMLHTTP")}catch(d){try{h=new XMLHttpRequest()}catch(b){h=false}}}function g(){var e;if(a.success){e=h.responseText;if(a.dataType=="json"){e=CanvasEngine.parseJSON(e)}else{if(a.dataType=="xml"){e=h.responseXML}}a.success(e)}}h.onreadystatechange=function(){if(h.readyState==4){if(a.statusCode&&a.statusCode[h.status]){a.statusCode[h.status]()}if(h.status==200){g()}else{if(a.error){a.error(h)}}}};h.open(a.type,a.url,true);if(a.mimeType){h.overrideMimeType(a.mimeType)}h.send(a.data)};CanvasEngine.getJSON=function(a,b,d){if(typeof b=="function"){d=b;b=null}CanvasEngine.ajax({url:a,dataType:"json",data:b,success:d})};CanvasEngine.parseJSON=function(a){return JSON.parse(a)};CanvasEngine.each=function(e,d){var b,a;if(e instanceof Array){a=e.length}else{a=e;e=[]}for(b=0;b<a;++b){d.call(e,b,e[b])}};CanvasEngine.inArray=function(b,d){var a;for(a=0;a<d.length;++a){if(b==d[a]){return a}}return -1};CanvasEngine.clone=function(a){var d;if(typeof(a)!="object"||a==null){return a}var b=a.constructor();if(b===undefined){return a}for(d in a){b[d]=CanvasEngine.clone(a[d])}return b};CanvasEngine.hexaToRGB=function(h){var f,e,a;function d(b){return(b.charAt(0)=="#")?b.substring(1,7):b}f=parseInt((d(h)).substring(0,2),16);e=parseInt((d(h)).substring(2,4),16);a=parseInt((d(h)).substring(4,6),16);return[f,e,a]};CanvasEngine.rgbToHex=function(e,d,a){return((1<<24)+(e<<16)+(d<<8)+a).toString(16).slice(1)};CanvasEngine._getRandomColorKey=function(){var e=Math.round(Math.random()*255),d=Math.round(Math.random()*255),a=Math.round(Math.random()*255);return CanvasEngine.rgbToHex(e,d,a)};CanvasEngine.random=function(b,a){return Math.floor((Math.random()*a)+b)};CanvasEngine.mobileUserAgent=function(){var a=navigator.userAgent;if(a.match(/(iPhone)/)){return"iphone"}else{if(a.match(/(iPod)/)){return"ipod"}else{if(a.match(/(iPad)/)){return"ipad"}else{if(a.match(/(BlackBerry)/)){return"blackberry"}else{if(a.match(/(Android)/)){return"android"}else{if(a.match(/(Windows Phone)/)){return"windows phone"}else{return false}}}}}}};CanvasEngine._benchmark={};CanvasEngine._interval_benchmark=60;CanvasEngine._freq_benchmark={};CanvasEngine.microtime=function(){var a=new Date().getTime()/1000;var b=parseInt(a,10);return a*1000};CanvasEngine.benchmark=function(b){var a=this.microtime();if(this._benchmark[b]){console.log("Performance "+b+" : "+(a-this._benchmark[b])+"ms")}this._benchmark[b]=a};CanvasEngine.objectSize=function(d){var b=0,a;for(a in d){if(d.hasOwnProperty(a)){b++}}return b};CanvasEngine.extend=function(b,a,d){if(!b){b={}}if(!a){a={}}return Kernel._extend(b,a,d)};if(typeof exports=="undefined"){var _ua=navigator.userAgent.toLowerCase(),_version=/(chrome|firefox|msie|version)(\/| )([0-9.]+)/.exec(_ua);CanvasEngine.browser={mozilla:/mozilla/.test(_ua)&&!/webkit/.test(_ua),webkit:/webkit/.test(_ua),opera:/opera/.test(_ua),msie:/msie/.test(_ua),version:_version?_version[3]:null,which:function(){var a;CanvasEngine.each(["mozilla","webkit","opera","msie"],function(d,b){if(CanvasEngine.browser[b]){a=b}});return{ua:a,version:CanvasEngine.browser.version}}}}CanvasEngine.moveArray=function(f,e,d){var b,a;e=parseInt(e,10);d=parseInt(d,10);if(e!==d&&0<=e&&e<=f.length&&0<=d&&d<=f.length){a=f[e];if(e<d){for(b=e;b<d;b++){f[b]=f[b+1]}}else{for(b=e;b>d;b--){f[b]=f[b-1]}}f[d]=a}return f};CanvasEngine.toTimer=function(e){var a=""+Math.floor(e/60/60),b=""+Math.floor(e/60%60),d=""+Math.floor(e%60);if(a.length==1){a="0"+a}if(b.length==1){b="0"+b}if(d.length==1){d="0"+d}return{hour:a,min:b,sec:d}};CanvasEngine.algo={pascalTriangle:function(a){a=a||10;var f=[[1,1],[1,2,1]],b=a-f.length;for(var e=f.length;e<=b;e++){f[e]=[1];for(var d=1;d<=e;d++){f[e][d]=f[e-1][d]+f[e-1][d-1]}f[e][e+1]=1}return f},};CanvasEngine.toMatrix=function(h,g,a){var d=[],b=0;for(var e=0;e<a;e++){for(var f=0;f<g;f++){if(!d[f]){d[f]=[]}d[f][e]=h[b];b++}}return d};CanvasEngine.rotateMatrix=function(g,e){var a=[],f=[];e=e||"90";if(e=="90"||e=="-90"){for(var b=0;b<g[0].length;b++){a[b]=[];for(var d=0;d<g.length;d++){a[b][d]=g[d][b]}}}if(e=="-90"){var b=0;for(var d=a.length-1;d>=0;d--){f[b]=a[d];b++}return f}if(e=="180"){for(var d=0;d<g.length;d++){a[d]=g[d].reverse()}}return a};var _CanvasEngine=CanvasEngine;if(typeof(exports)!=="undefined"){exports.Class=Class;exports.CanvasEngine=CanvasEngine}(function(){var b=0;var d=["ms","moz","webkit","o"];for(var a=0;a<d.length&&!window.requestAnimationFrame;++a){window.requestAnimationFrame=window[d[a]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[d[a]+"CancelAnimationFrame"]||window[d[a]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(i,f){var e=new Date().getTime();var g=Math.max(0,16-(e-b));var h=window.setTimeout(function(){i(e+g)},g);b=e+g;return h}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(e){clearTimeout(e)}}}());if(typeof Element!="undefined"){var prop,vendors=["ms","moz","webkit","o","khtml"];for(var x=0;x<vendors.length&&!Element.prototype.requestFullScreen;++x){Element.prototype.requestFullScreen=Element.prototype[vendors[x]+"RequestFullScreen"];document.cancelFullScreen=document[vendors[x]+"CancelFullScreen"]}}Class.create("ModelClientClass",{create:function(b,d,a){if(!(d instanceof Array)){a=d;d=false}a.events=d;Class.create(b,a)},"new":function(b){var a=Class["new"](b).extend({_methods:{},emit:function(f,i,k){if(!i){i=[]}if(typeof i=="function"){k=i}if(k){this.on(f,k)}if(this[f]){if(!(i instanceof Array)){var h=[];for(var g in i){h.push(i[g])}i=h}var e=this[f].apply(this,i);this.call(f,e)}},on:function(e,f){if(!this._methods[e]){this._methods[e]={}}this._methods[e].callback=f},call:function(e,f){if(this._methods[e]){this._methods[e].callback(f)}}});if(this.events){for(var d in this.events){obj=a[events[d]];if(obj){obj.on(this.events[d],function(e){if(!e){e={}}obj.call(a,e)})}}}return a}});var Model=Class["new"]("ModelClientClass"),Global_CE;CanvasEngine.io=null;CanvasEngine.socketIO=function(){if(typeof(io)=="undefined"){throw"Please add socket.io - http://socket.io"}return io};CanvasEngine.User={authentication:function(d,a,b){CanvasEngine.socketIO();CanvasEngine.io.emit("_authentication",{username:d,password:a});CanvasEngine.io.on("_authentication",function(e){if(e.ret=="success"&&b.success){b.success()}else{if(e.ret=="failed"&&b.failed){b.failed(e.err)}}})},register:function(d,a,b){CanvasEngine.socketIO();CanvasEngine.io.emit("_register",{username:d,password:a,data:b.data});CanvasEngine.io.on("_register",function(e){if(e.ret=="success"&&b.success){b.success()}else{if(e.ret=="failed"&&b.failed){b.failed(e.err)}}})}};CanvasEngine.connectServer=function(b,a){CanvasEngine.socketIO();CanvasEngine.io=io.connect(b+":"+a)};CanvasEngine.defines=function(a,d){d=d||{};if(d.render===undefined){d.render=true}if(typeof a=="string"){a=[a]}var b;Class.create("CanvasEngineClass",{_noConflict:false,initialize:function(e){this.canvas=a;this.el_canvas=[]},ready:function(g){var e=this;b.Sound._manager=typeof(soundManager)!=="undefined";if(b.Sound._manager){soundManager.setup(_CanvasEngine.extend({url:d.swf_sound?d.swf_sound:"swf/",onready:f},d.soundmanager))}else{if(!g){f()}else{window.onload=f}}function f(){for(var h=0;h<e.canvas.length;h++){e.el_canvas.push(e.Canvas["new"](e.canvas[h]))}if(d.render){b.Scene._loop(e.el_canvas)}if(g){g()}}return this},plugins:function(){},mouseover:false,noConflict:function(){this._noConflict=true},Materials:{images:{},_buffer:{},_cache_canvas:{},sounds:{},videos:{},fonts:{},data:{},get:function(f,e){if(e){return this[e+"s"][f]}if(_m=this.images[f]||this.sounds[f]||this.videos[f]||this.data[f]){return _m}else{if(f instanceof Image||f instanceof HTMLCanvasElement||f instanceof HTMLVideoElement||f instanceof HTMLAudioElement){return f}}if(d.ignoreLoadError){return false}throw'Cannot to get the data "'+f+'" because it does not exist'},imageToCanvas:function(m,l){l=l||{};if(this._cache_canvas[m]&&l.cache){return this._cache_canvas[m]}var g=this.get(m),i,f;if(!g){return}var e=l.width||g.width,k=l.height||g.height,i=document.createElement("canvas");i.width=e;i.height=k;f=i.getContext("2d");f.drawImage(g,0,0,g.width,g.height,0,0,e,k);this._cache_canvas[m]={canvas:i,ctx:f};return this._cache_canvas[m]},createBuffer:function(e){var f="_opaque_"+e;if(!this._buffer[f]){this._buffer[f]=this.opaqueImage(e)}return this._buffer[f]},transparentColor:function(g,o,f){var e,q,s,r=this.imageToCanvas(g,{cache:f}),h=r.canvas,u=r.ctx;e=u.getImageData(0,0,h.width,h.height);q=e.data;s=_CanvasEngine.hexaToRGB(o);for(var p=0,k=q.length;p<k;p+=4){var l=q[p];var m=q[p+1];var t=q[p+2];if(l==s[0]&&m==s[1]&&t==s[2]){q[p+3]=0}}u.putImageData(e,0,0);return h},invertColor:function(n,f){var m,l,k=this.imageToCanvas(n),g=k.canvas,e=k.ctx;m=e.getImageData(0,0,g.width,g.height);l=m.data;for(var h=0;h<l.length;h+=4){l[h]=255-l[h];l[h+1]=255-l[h+1];l[h+2]=255-l[h+2]}e.putImageData(m,0,0);return g},cropImage:function(f,o,n,p,k){var e,i,m,l=this.imageToCanvas(f);if(!l){return}var g=l.canvas,q=l.ctx;e=q.getImageData(o,n,p,k);g.width=p;g.height=k;q.putImageData(e,0,0);return g},opaqueImage:function(k){var h=this.imageToCanvas(k),f=h.canvas,e=h.ctx;imageData=e.getImageData(0,0,f.width,f.height);data=imageData.data;for(var g=0;g<data.length;g+=4){if(data[g+3]>0){data[g+3]=255}}e.putImageData(imageData,0,0);return f},getExtension:function(e){return(/[.]/.exec(e))?/[^.]+$/.exec(e)[0]:undefined},getBasePath:function(g,e){var f=g.substring(0,g.lastIndexOf("/"));return f!=""&&e?f+"/":f},getFilename:function(g,e){var f=g.replace(/^.*[\\\/]/,"");if(!e){f=f.split(".")}else{return f}return f.slice(0,f.length-1).join(".")},Transition:{_data:{},set:function(n,l){var m,h,e=[];if(this._data[n]){return this._data[n]}if(!(n instanceof Array)){var k=b.Materials.imageToCanvas(n,{width:1024,height:768});if(typeof Uint8ClampedArray!="undefined"){e=new Uint8ClampedArray(k.canvas.width*k.canvas.height)}m=k.ctx.getImageData(0,0,k.canvas.width,k.canvas.height);h=m.data;var f=0;for(var g=0;g<h.length;g+=4){e[f]=h[g];f++}}else{e=l}this._data[n]=e;return e},get:function(e){return this._data[e]}},load:function(o,w,q,n){var h=0,e,u=this,t=[],v;if(!(w instanceof Array)){w=[w]}for(var g=0;g<w.length;g++){e=w[g];if(e.id){t.push(e)}else{for(var s in e){v={};v=_CanvasEngine.extend({},e[s]);if(typeof e[s]=="string"){v.path=e[s]}if(v.id){v._id=v.id}v.id=s;t.push(v)}}}switch(o){case"images":r();break;case"sounds":k();break;case"fonts":f();break;case"videos":m();break;case"data":l();break}function r(){var i;if(t[h]){i=new Image();i.onload=function(){var p;if(t[h].transparentcolor){p=u.transparentColor(i,t[h].transparentcolor)}if(t[h].invertcolor){p=u.invertColor(i)}else{p=i}u.images[t[h].id]=p;if(t[h].transition){u.Transition.set(t[h].id)}h++;if(q){q.call(u,p)}r()};i.onerror=function(p){if(d.ignoreLoadError){h++;if(q){q.call(u,p)}r()}};i.src=t[h].path}else{if(n){n.call(u)}}}function k(){var B;function C(){h++;if(q){q.call(u,this)}k()}if(t[h]){if(b.Sound._manager){if(u.sounds[t[h].id]){C()}else{u.sounds[t[h].id]=soundManager.createSound({id:t[h].id,url:t[h].path,autoLoad:true,autoPlay:false,onload:C,onfinish:function(){if(this._loop){this.play()}}})}}else{var A=new Audio(),p=t[h].path,y=u.getBasePath(p),i=u.getFilename(p),z=u.getExtension(p);var E={mp3:A.canPlayType("audio/mpeg"),ogg:A.canPlayType('audio/ogg; codecs="vorbis"'),m4a:A.canPlayType('audio/mp4; codecs="mp4a.40.2"')};if(!E[z]){for(var D in E){if(z==D){continue}if(E[D]){p=y+"/"+i+"."+D;break}}}A.setAttribute("src",p);A.addEventListener("canplaythrough",function(){u.sounds[t[h].id]=this;C()},false);A.addEventListener("ended",function(){if(!this._loop){return}this.currentTime=0;this.play()},false);A.addEventListener("error",function(F){if(d.ignoreLoadError){C()}},false);A.load();A.pause();document.body.appendChild(A);if(/^i/.test(_CanvasEngine.mobileUserAgent())){u.sounds[t[h].id]=A;C()}}}else{if(n){n.call(u)}}}function f(){var i=t[h];if(i){if(i.id=="google"||i.id=="ascender"||i.id=="typekit"||i.id=="monotype"||i.id=="fontdeck"){var A={};A[i.id]=i;if(i._id){A[i.id].id=i._id}if(typeof WebFontConfig=="undefined"){WebFontConfig={}}WebFontConfig=_CanvasEngine.extend(WebFontConfig,A)}else{var y=document.createElement("style");var z=u.getBasePath(i.path,true)+u.getFilename(i.path)+"."+(_CanvasEngine.browser.msie?"eot":"ttf");y.innerHTML="@font-face { font-family: '"+i.id+"'; src: url('"+z+"'); font-weight: normal; font-style: normal;}";document.getElementsByTagName("head")[0].appendChild(y)}h++;if(q){q.call(u,this)}f()}else{if(!document.getElementById("google-webfont")){var p=document.createElement("script");p.src=("https:"==document.location.protocol?"https":"http")+"://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js";p.type="text/javascript";p.async="true";p.id="google-webfont";var y=document.getElementsByTagName("script")[0];y.parentNode.insertBefore(p,y)}if(n){n.call(u)}}}function m(){function z(){h++;if(q){q.call(u,this)}m()}if(t[h]){var y=document.createElement("video");if(t[h].webcam){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;function i(A){window.stream=A;if(window.URL){y.src=window.URL.createObjectURL(A)}else{y.src=A}u.videos[t[h].id]=y;z()}function p(A){throw"navigator.getUserMedia error: "+A}navigator.getUserMedia(t[h].webcam,i,p)}else{y.src=t[h].path;y.addEventListener("loadeddata",function(){u.videos[t[h].id]=y;z()},false);y.onerror=function(A){if(d.ignoreLoadError){z()}else{throw"Video error #"+A.target.error.code+": See http://dev.w3.org/html5/spec-author-view/video.html#dom-mediaerror-media_err_aborted"}};y.load()}document.body.appendChild(y);y.setAttribute("style","display:none;")}else{if(n){n.call(u)}}}function l(){function i(){h++;if(q){q.call(u,this)}l()}if(t[h]){_CanvasEngine.ajax({url:t[h].path,dataType:"json",success:function(p){u.data[t[h].id]=p;i()},error:function(){if(d.ignoreLoadError){i()}}})}else{if(n){n.call(u)}}}}},Sound:{_fade:{},_manager:false,get:function(f){var e=b.Materials.get(f,"sound");return e},allStop:function(g){g=g||"";var e=b.Materials.sounds;for(var f in e){if(f!=g){this.stop(f)}}return this},stop:function(f){var e=this.get(f);if(d.soundmanager){e.stop()}else{e.currentTime=0;e.pause()}e._loop=false;return this},play:function(e){this.get(e).play();return this},playOnly:function(e){this.allStop(e);this.get(e).play();return this},playLoop:function(f){var e=this.get(f);e._loop=true;e.play();return this},fadeIn:function(g,e,f){this.fadeTo(g,e,1,f)},fadeOut:function(g,e,f){this.fadeTo(g,e,0,f)},fadeTo:function(k,g,i,h){var f=this.get(k),e=this._manager?f.volume/100:f.volume;this._fade[k]={sound:f,init:e,c_volume:e,f_time:g,to:i,callback:h}},_loop:function(){var g,f;for(var e in this._fade){g=this._fade[e];f=false;if(g){if(g.init<g.to){if(g.c_volume>=g.to){g.c_volume=g.to;f=true}else{g.c_volume+=(Math.abs(g.to-g.init)/g.f_time)}if(g.c_volume>0.999){g.c_volume=1}}else{if(g.c_volume<=g.to){g.c_volume=g.to;f=true}else{g.c_volume-=(Math.abs(g.to-g.init)/g.f_time)}if(g.c_volume<0.001){g.c_volume=0}}if(this._manager){g.sound.setVolume(g.c_volume*100)}else{g.sound.volume=g.c_volume}if(f){if(g.callback){g.callback.call(g.sound)}delete this._fade[e];break}}}}},Canvas:{"new":function(e){return Class["new"]("Canvas",[e])}},Element:{"new":function(h,f,g,e){return Class["new"]("Element",[h,f,g,e])}},Context:{"new":function(e){return Class["new"]("Context",[e])}},Scene:{_scenes:{},_cacheScene:{},_scenesEnabled:{},_scenesIndex:[],_scenesNbCall:{},_current:null,New:function(){return this["new"].apply(this,arguments)},"new":function(f){var e;if(typeof f=="string"){if(!this._cacheScene[f]){throw"Please initialize '"+f+"' scene with an object before"}f=this._cacheScene[f]}else{this._cacheScene[f.name]=f}e=Class["new"]("Scene",[f]).extend(f,false);this._scenesNbCall[f.name]=0;this._scenes[f.name]=e;return e},call:function(g,h){if(this._scenesNbCall[g]>0){this.New(g)}var e=this._scenes[g],f=[g];h=h||{};if(e){this._scenesEnabled[g]=e;if(this._scenesIndex.indexOf(g)==-1){if(h.transition){this._scenesIndex=f.concat(this._scenesIndex)}else{this._scenesIndex.push(g)}}if(h.exitScenes){h.exitScenes.allExcept=h.exitScenes.allExcept||[];h.exitScenes.allExcept=f.concat(h.exitScenes.allExcept);e._load.call(e,h.exitScenes,h.params)}else{if(!h.overlay&&!h.transition){this.exitAll(f)}e._load.call(e,h,h.params)}this._scenesNbCall[g]++}else{throw'Scene "'+g+"\" doesn't exist"}return e},exit:function(f){var e=this._scenesEnabled[f];if(e){e._exit.call(e);for(var g=0;g<this._scenesIndex.length;g++){if(this._scenesIndex[g]==f){this._scenesIndex.splice(g,1);break}}delete this._scenesEnabled[f]}},isEnabled:function(e){return this._scenesEnabled[e]?true:false},exitAll:function(f){var e;if(!(f instanceof Array)){f=[f]}for(e in this._scenesEnabled){if(_CanvasEngine.inArray(e,f)){this.exit(e)}}},exist:function(e){return this._scenes[e]?true:false},get:function(e){return this._scenes[e]},getEnabled:function(){return this._scenesEnabled},_loop:function(h){var f=this,g,i;this.fps=0;var l=new Date().getTime(),k;function e(){var n,m=0;k=(new Date().getTime()-l)/1000;l=new Date().getTime();f.fps=1/k;b.Sound._loop();h[m].clear();h[m]._ctxMouseEvent.clearRect(0,0,h[m].width,h[m].height);for(g=0;g<f._scenesIndex.length;g++){i=f._scenesEnabled[f._scenesIndex[g]];if(i){i._loop()}}requestAnimationFrame(e)}requestAnimationFrame(e)},getFPS:function(){return ~~this.fps},getPerformance:function(){return ~~(this.getFPS()/60*100)}}});Class.create("Canvas",{id:null,element:null,stage:null,ctx:null,_globalElements:{},_ctxTmp:null,_layerDOM:null,_layerParent:null,_ctxMouseEvent:null,width:0,height:0,mouseEvent:true,initialize:function(f){var u=this,r,m;this.id=f;var g=this._getElementById(f);if(g.tagName!="CANVAS"&&g.tagName!="canvas"){this.element=document.createElement("canvas");this._layerDOM=document.createElement("div");r=this.element.width=g.getAttribute("width");m=this.element.height=g.getAttribute("height");this.element.style.position="absolute";g.style.position=this._layerDOM.style.position="relative";g.style.width=r+"px";g.style.height=m+"px";g.style.overflow=this._layerDOM.style.overflow="hidden";this._layerDOM.style.width="100%";this._layerDOM.style.height="100%";g.appendChild(this.element);g.appendChild(this._layerDOM);this._layerParent=g}else{this.element=g}this.width=this.element.width;this.height=this.element.height;this.ctx=this.element.getContext("2d");this.hammerExist=typeof(Hammer)!=="undefined";this._mouseEvent();var t=["click","dbclick","mousemove","mousedown","mouseup"],q=["dragstart","drag","dragend","dragup","dragdown","dragleft","dragright","swipe","swipeup","swipedown","swipeleft","swiperight","rotate","pinch","pinchin","pinchout","tap","doubletap","hold","transformstart","transform","transformend","release","touch","release"];var p=this._layerParent||this.element;var n=null,k;if(this.hammerExist){n=new Hammer(p)}function o(h){p.addEventListener(h,function(i){s(i,h)},false)}function e(h){n.on(h,function(i){s(i,h)})}function s(B,z){var A,w,h=b.Scene.getEnabled(),v;if(B.gesture){A=B.gesture.touches}else{A=[u.getMousePosition(B)]}for(var i in h){v=h[i].getStage();for(var y=0;y<A.length;y++){k=A[y];if(k.pageX!==undefined){k=u.getMousePosition(k)}if(z=="mousemove"){if(u.mouseEvent){v._mousemove(B,k)}else{continue}}v.trigger(z,[B,k]);v._select(k,function(C){C.trigger(z,[B,k])})}}}if(n){for(var l=0;l<q.length;l++){e.call(this,q[l])}}for(var l=0;l<t.length;l++){o.call(this,t[l])}if(!d.contextmenu){p.addEventListener("contextmenu",function(h){h.preventDefault()})}},_elementsByScene:function(e,f,g){if(!this._globalElements[e]){this._globalElements[e]={}}if(!g){if(f){return this._globalElements[e][f]}return this._globalElements[e]}this._globalElements[e][f]=g},_getElementById:function(f){var e;if(d.cocoonjs){e=document.createElement("canvas");e.width=d.cocoonjs.width;e.height=d.cocoonjs.height;e.id=f;document.body.appendChild(e)}else{e=document.getElementById(f)}return e},_mouseEvent:function(){var e=document.createElement("canvas");e.width=this.width;e.height=this.height;this._ctxMouseEvent=e.getContext("2d")},canvasReady:function(){},getMousePosition:function(l){var k=this.element;var i=0;var h=0;while(k&&k.tagName!="BODY"){i+=k.offsetTop;h+=k.offsetLeft;k=k.offsetParent}if(l.clientX==undefined){l.clientX=l.pageX}if(l.clientY==undefined){l.clientY=l.pageY}if(!window.pageXOffset){window.pageXOffset=0}if(!window.pageYOffset){window.pageYOffset=0}var g=l.clientX-h+window.pageXOffset;var f=l.clientY-i+window.pageYOffset;return{x:g,y:f}},measureText:function(f,e,g){var h;g=g||"Arial";e=e||"12px";this.ctx.font="normal "+e+" "+g;h=this.ctx.measureText(f);this.ctx.font=null;return h},createPattern:function(f,e){e=e||"repeat";var g=b.Materials.get(f);if(!g){return}return this.ctx.createPattern(g,e)},createLinearGradient:function(f,h,e,g){return this.ctx.createLinearGradient(f,h,e,g)},createRadialGradient:function(h,k,g,f,i,e){return this.ctx.createRadialGradient(h,k,g,f,i,e)},addColorStop:function(f,e){return this.ctx.addColorStop(f,e)},getImageData:function(e,i,f,g){if(!e){e=0;i=0}if(!f){f=this.width;g=this.height}return this.ctx.getImageData(e,i,f,g)},putImageData:function(h,g,l,f,k,e,i){if(!g){g=0;l=0}return this.ctx.putImageData(h,g,l,f,k,e,i)},createImageData:function(){return this.ctx.createImageData.apply(this.ctx,arguments)},toDataURL:function(){return this.ctx.toDataURL()},clear:function(){return this.ctx.clearRect(0,0,this.width,this.height)},cursor:function(){function e(f){f.preventDefault();f.stopPropagation();f.target.style.cursor="move"}document.addEventListener("mousemove",e,false)},isFullscreen:function(){return document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen},setSize:function(e,m,g){var i,n=this,l=this.element.width,h=this.element.height,k=e;if(e=="reset"){e=this._oldSize.width;m=this._oldSize.height;this.element.style.width=this.element.style.height=null;if(this._oldSize.type=="browser"){this.element.style.position=this.element.style.top=this.element.style.left=null}else{if(this._oldSize.type=="fullscreen"){document.cancelFullScreen()}}}else{if(e=="fullscreen"){g=m;e=screen.width;m=screen.height;if(this.element.requestFullScreen){this.element.requestFullScreen()}else{e=k="browser"}}}if(e=="browser"){g=m;e=window.innerWidth;m=window.innerHeight;var f=this.element;if(this._layerParent){f=this._layerParent}f.style.position="fixed";f.style.top=f.style.left=0;window.onresize=function(o){if(k=="browser"){n.setSize("browser",g)}}}if(g=="fit"){i=l/h;e=m*i;this.element.style.width=e+"px";this.element.style.height=m+"px"}else{if(g=="stretch"){this.element.style.width=e+"px";this.element.style.height=m+"px"}else{this.element.width=e;this.element.height=m}}if(this._layerParent){this._layerParent.style.width=e+"px";this._layerParent.style.height=m+"px"}this._oldSize={width:l,height:h,type:k};this.width=e;this.height=m;return this}});Class.create("Scene",{id:0,_stage:{},_events:[],_pause:false,_isReady:false,_index:0,model:null,initialize:function(g){var f,e=this;this.id=_CanvasEngine.uniqid();this._events=g.events},_loop:function(){if(this._isReady){if(this._pause){this._stage.refresh()}else{if(this.render){this.render.call(this,this._stage)}else{this._stage.refresh()}}}},emit:function(e,f){this.model.call(e,f)},getElement:function(e){if(this._global_elements[e]){return this._global_elements[e]}return this.createElement(e)},pause:function(e){if(e===undefined){return this._pause}this._pause=e;return this},togglePause:function(){return this.pause(!this._pause)},getStage:function(){return this._stage},getCanvas:function(e){if(!e){e=0}return b.el_canvas[e]},zIndex:function(f){var e;if(f===undefined){return this._index}if(f instanceof Class){f=f.zIndex()}e=b.Scene._scenesIndex.length;if(Math.abs(f)>=e){f=-1}if(f<0){f=e+f}_CanvasEngine.moveArray(b.Scene._scenesIndex,this._index,f);this._index=f;return this},createElement:function(f,k,e){if(f instanceof Array){var l={};for(var g=0;g<f.length;g++){l[f[g]]=this.createElement(f[g])}return l}if(typeof f!="string"){e=k;k=f}var h=b.Element["new"](this,null,k,e);h.name=f;return h},_exit:function(){this.getCanvas()._elementsByScene[this.name]={};if(this.exit){this.exit.call(this)}},loadEvents:function(){var e=this;if(_CanvasEngine.io&&this._events){_CanvasEngine.each(this._events,function(f,g){_CanvasEngine.io.on(e.name+"."+g,function(h){if(e[g]&&b.Scene.isEnabled(e.name)){e[g].call(e,h)}})})}},_load:function(h,u){var t=this;h=h||{};u=u||{};this._stage=b.Element["new"](this);this._index=b.Scene._scenesIndex.length-1;for(var k=0;k<b.el_canvas.length;k++){b.el_canvas[k].stage=this._stage}if(this.model){if(this._events){CE.each(this._events,function(v,w){t.model.on(w,function(i){t[w].call(t,i)})})}}this.loadEvents();var n=o("images"),e=o("sounds"),g=o("fonts"),l=o("videos"),f=o("data"),r=n+e+g+l+f,m=0;if(n>0){p("images")}if(e>0){p("sounds")}if(g>0){p("fonts")}if(l>0){p("videos")}if(f>0){p("data")}if(n==0&&e==0&&g==0&&l==0&&f==0){s()}function p(i){b.Materials.load(i,t.materials[i],function(){q()})}function q(){m++;if(t.preload){t.preload(t._stage,m/r*100)}if(r==m){s()}}function o(y){var w=0;if(!t.materials){return 0}if(t.materials[y]){for(var v in t.materials[y]){w++}}return w}function s(){if(h.when=="afterPreload"){b.Scene.exitAll(h.allExcept)}if(t.ready){t.ready(t._stage,t.getElement,u)}t._stage.trigger("canvas:readyEnd");if(t.model&&t.model.ready){t.model.ready.call(t.model)}t._isReady=true;if(h.transition){if(h.transition===true){h.transition={type:"fade"}}t.execTransition(h.transition.type,h.transition,h.overlay)}}},execTransition:function(p,l,h){var r=this,o;l=l||{};l=_CanvasEngine.extend({frames:30},l);var f=b.Scene.getEnabled(),m=0,n;for(var t in f){if(f[t].id==this.id){continue}n=f[t].getStage();o=f[t].getCanvas();switch(p){case"fade":if(!b.Timeline){throw"Add the Timeline class for transitions"}b.Timeline.New(n).to({opacity:0},l.frames).call(function(){if(!h){b.Scene.exitAll(r.name)}if(l.finish){l.finish.call(r)}f[t].zIndex(0)});break;case"image":var o=n.buffer(o.width,o.height),q=o.getContext("2d");var i=0;var g=new Worker("workers/transition.js");g.addEventListener("message",function(k){if(i==0){n.empty()}q.putImageData(k.data.imageData,0,0);n.drawImage(o);i++;if(k.data.finish){g.terminate();if(l.finish){l.finish.call(r)}if(!h){b.Scene.exitAll(r.name)}}});var e=q.getImageData(0,0,o.width,o.height);g.postMessage({imgData:e,pattern:b.Materials.Transition.get(l.id)});n.on("canvas:refresh",function(k){g.postMessage("")});m++;break}}}});Class.create("Context",{_cmd:{},img:{},_useClip:false,globalAlpha:1,_PROPS:["shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","globalAlpha","globalCompositeOperation","lineJoin","lineWidth","miterLimit","fillStyle","font","textBaseline","strokeStyle"],alpha:function(e){},_setMethod:function(f,g){var e=this;this[f]=function(){var h=g=="cmd"?"_addCmd":"draw";e[h](f,arguments)}},_defaultRectParams:function(e,k,f,g,i){if(typeof e=="string"){this.fillStyle=e;e=k;k=f;f=g;g=i}if(e==undefined){e=0;k=0}if(f==undefined){f=this.width;g=this.height}return[e,k,f,g]},fillRect:function(e,i,f,g){this._addCmd("fillRect",this._defaultRectParams.apply(this,arguments),["fillStyle"])},fill:function(){this._addCmd("fill",[],["fillStyle"])},fillText:function(f,e,g){this._addCmd("fillText",[f,e,g],["fillStyle","font","textBaseline"])},strokeText:function(f,e,g){this._addCmd("strokeText",[f,e,g],["strokeStyle","font","textBaseline"])},strokeRect:function(e,i,f,g){this._addCmd("strokeRect",this._defaultRectParams.apply(this,arguments),["strokeStyle"])},stroke:function(){this._addCmd("stroke",[],["strokeStyle"])},drawImage:function(i,p,o,q,k,s,r,e,n){var l,f,h,m=i;if(!p){p=0}if(!o){o=0}if(typeof i==="string"){m=b.Materials.get(i);if(!m){return}this.img.width=m.width;this.img.height=m.height}if(/%$/.test(q)){s=p;r=o;p=0;o=0;q=m.width*parseInt(q)/100;k=m.height;e=q;n=k}var g=new RegExp("^"+window.location.origin,"g");if(!g.test(m.src)){h=m}else{h=b.Materials.createBuffer(i)}if(q!==undefined){l=[m,p,o,q,k,s,r,e,n];f=[h,p,o,q,k,s,r,e,n];this._buffer_img={params:f,x:s,y:r,width:e,height:n}}else{l=[m,p,o];f=[h,p,o];this._buffer_img={params:f,x:p,y:o,width:m.width,height:m.height}}this._addCmd("drawImage",l)},moveTo:function(){this._addCmd.call(this,"moveTo",arguments)},lineTo:function(){this._addCmd.call(this,"lineTo",arguments)},quadraticCurveTo:function(){this._addCmd.call(this,"quadraticCurveTo",arguments)},bezierCurveTo:function(){this._addCmd.call(this,"bezierCurveTo",arguments)},beginPath:function(){this._addCmd.call(this,"beginPath",arguments)},closePath:function(){this._addCmd.call(this,"closePath",arguments)},clip:function(){this._useClip=true;this._addCmd.call(this,"clip",arguments)},rect:function(){this._addCmd("rect",this._defaultRectParams.apply(this,arguments))},arc:function(){this._addCmd.call(this,"arc",arguments)},arcTo:function(){this._addCmd.call(this,"arcTo",arguments)},addColorStop:function(){this._addCmd.call(this,"addColorStop",arguments)},isPointInPath:function(){this._addCmd.call(this,"isPointInPath",arguments)},rotate:function(){this.draw.call(this,"rotate",arguments)},translate:function(){this.draw.call(this,"translate",arguments)},transform:function(){this.draw.call(this,"transform",arguments)},setTransform:function(){this.draw.call(this,"setTransform",arguments)},resetTransform:function(){this.draw.call(this,"resetTransform",arguments)},clearRect:function(){this.draw.call(this,"clearRect",arguments)},scale:function(){this.draw.call(this,"scale",arguments)},rotateDeg:function(e){this.rotate(e*Math.PI/180)},save:function(e){if(e){this._addCmd("save")}else{this.draw("save")}},restore:function(e){if(e){this._addCmd("restore")}else{this.draw("restore")}},clearPropreties:function(){var f=this._PROPS;for(var e=0;e<f.length;e++){if(this[f[e]]){this[f[e]]=undefined}}},_bufferEvent:function(f,e){var g=this._canvas[0]["_ctxMouseEvent"];if(this.hasEvent()||this._useClip){if(f=="drawImage"&&!this._forceEvent){g[f].apply(this._canvas[0]["_ctxMouseEvent"],this._buffer_img.params);g.globalCompositeOperation="source-atop";g.fillStyle="#"+this.color_key;g.fillRect(this._buffer_img.x,this._buffer_img.y,this._buffer_img.width,this._buffer_img.height)}else{g[f].apply(this._canvas[0]["_ctxMouseEvent"],e)}}},draw:function(g,m,q){var o="ctx",t;if(!m){m=[]}if(!q){q={}}var t=this.getScene().getCanvas()._ctxTmp;var k,f={};var i={};var h=true,p=1,e=false;var l=function(w,u,v){if(w[u]||this._forceEvent){this._canvas[0]["_ctxMouseEvent"][u]=v;return 0}return 1};if(g&&typeof g!="string"){t=g;g=null}if(g){f[g]={params:m,propreties:q};h=false}else{f=this._cmd}for(var r in f){k=f[r];for(var n=0;n<this._canvas.length;n++){i=k.propreties;if(h&&r=="restore"){this.clearPropreties()}if(i){for(var s in i){p=1;if(s=="globalAlpha"){i[s]=this.real_opacity}if(t){t[s]=i[s]}else{this._canvas[n][o][s]=i[s]}p&=l.call(this,i,"globalAlpha",1);p&=l.call(this,i,"strokeStyle","#"+this.color_key);p&=l.call(this,i,"fillStyle","#"+this.color_key);if(p){l.call(this,i,s,i[s])}}}if(t){t[r].apply(t,k.params)}else{this._canvas[n][o][r].apply(this._canvas[n][o],k.params);if(this._forceEvent){if(r=="rect"){this._bufferEvent("fillRect",k.params)}}this._bufferEvent(r,k.params)}}}},_addCmd:function(g,i,e){i=i||[];e=e||[];var l=this._PROPS;e=e.concat(l);var h={};for(var f=0;f<e.length;f++){if(this[e[f]]){h[e[f]]=this[e[f]]}}h.globalAlpha=1;this._cmd[g]={params:i,propreties:h}},hasCmd:function(e){return this._cmd[e]!==undefined},removeCmd:function(e){if(e=="clip"){this._useClip=false}delete this._cmd[e]}});Class.create("Element",{_children:[],_attr:{},x:0,y:0,real_x:0,real_y:0,real_scale_x:1,real_scale_y:1,real_rotate:0,real_skew_x:0,real_skew_y:0,real_opacity:1,real_propagation:true,scaleX:1,scaleY:1,skewX:0,skewY:0,opacity:1,rotation:0,width:null,height:null,regX:0,regY:0,parent:null,pause:false,_index:0,_id:null,_visible:true,_listener:{},_buffer_img:null,_out:1,_over:0,_nbEvent:0,_onRender:[],_pack:null,_forceEvent:false,propagationOpacity:null,initialize:function(k,g,h,e){this._id=_CanvasEngine.uniqid();this.width=h;this.height=e;this.scene=k;this.stage=k._stage;this.layer=g;var f,i=this.scene.getCanvas()._elementsByScene(this.scene.name);do{f=_CanvasEngine._getRandomColorKey()}while(f in i);this.color_key=f;this.scene.getCanvas()._elementsByScene(this.scene.name,f,this);this._canvas=b.el_canvas},_initParams:function(e){if(e||!this.parent){this.parent={scaleX:1,scaleY:1,real_x:0,real_y:0,real_scale_x:1,real_scale_y:1,real_rotate:0,real_skew_x:0,real_skew_y:0,real_opacity:1,real_propagation:true}}},refresh:function(){this._refresh(true,true);this._canvas._event_mouse=null},_refresh:function(l,g,e){if(this.stage._onRefresh){this.stage._onRefresh(this)}if(!this._visible){this._loop();return}if(!this.real_pause){this._initParams(l);this.real_propagation=this.parent.propagationOpacity==null?true:this.parent.propagationOpacity;this.save();this.real_scale_x=this.parent.real_scale_x*this.scaleX;this.real_scale_y=this.parent.real_scale_y*this.scaleY;this.real_y=(this.parent.real_y+this.y);this.real_x=(this.parent.real_x+this.x);this.real_skew_x=this.parent.real_skew_x+this.skewX;this.real_skew_y=this.parent.real_skew_y+this.skewY;this.real_rotate=this.parent.real_rotate+this.rotation;if(this.real_propagation){this.real_opacity=this.parent.real_opacity*this.opacity}else{this.real_opacity=this.opacity}this.real_pause=l?this.pause:this.parent.real_pause;this.globalAlpha=this.real_opacity;if(this.parent){if(this.parent.regX){this.regX=this.parent.regX}if(this.parent.regY){this.regY=this.parent.regY}}var k=this.real_x+this.regX;var h=this.real_y+this.regY;if(this.regX!=0||this.regY!=0){this.translate(k,h)}if(this.real_rotate!=0){this.rotateDeg(this.real_rotate)}if(this.real_scale_x!=1||this.real_scale_y!=1){this.scale(this.real_scale_x,this.real_scale_y)}if(this.real_skew_x!=0||this.real_skew_y!=0){this.transform(1,this.real_skew_x,this.real_skew_y,1,0,0)}if(this.regX!=0||this.regY!=0){this.translate(-k,-h)}this.translate(this.real_x,this.real_y)}this.draw(e);if(!this._useClip){this.restore()}if(g){if(!this.getScene()._pause){this._loop()}for(var f=0;f<this._children.length;f++){this._children[f]._refresh(false,true,e)}}if(this._useClip){this.restore()}},setX:function(e){this.x=e},setY:function(e){this.y=e},buffer:function(f,m){var l=this.children(),g=document.createElement("canvas"),e=g.getContext("2d"),o=this.getScene(),n=this.scene.getCanvas();g.width=f||n.width;g.height=m||n.height;this.scene.getCanvas()._ctxTmp=e;for(var k=0;k<l.length;k++){this._children[k]._refresh(true,true)}this.scene.getCanvas()._ctxTmp=null;return g},rotateTo:function(f,e){var g=parseInt(f);if(/rad$/.test(f)){g=g*180/Math.PI}this.rotation=e?360-g:g;this._stageRefresh();return this},setOriginPoint:function(e,f){if(e=="middle"){if(this.width&&this.height){e=Math.round(this.width/2);f=Math.round(this.height/2)}else{throw"Width and Height proprieties are not defined"}}if(e!==undefined){this.regX=+e}if(f!==undefined){this.regY=+f}return this},getScene:function(){return this.scene},_stageRefresh:function(){this.stage.refresh()},_mousemove:function(l,g){var f,k;for(var h=0;h<this._children.length;h++){f=this._children[h];k=g.x>f.real_x&&g.x<f.real_x+f.width&&g.y>f.real_y&&g.y<f.real_y+f.height;if(k){if(f._out==1){f._out++;f._out++;f._over=1;_trigger=f.trigger("mouseover",l)}if(_trigger){return}}else{if(f._over==1){f._out=1;f._over++;_trigger=f.trigger("mouseout",l)}}}},_select:function(g,i){var e,h;var f=this.scene.getCanvas();h=this._canvas[0]["_ctxMouseEvent"].getImageData(g.x,g.y,1,1).data;if(h[3]>0){e=f._elementsByScene(this.scene.name,_CanvasEngine.rgbToHex(h[0],h[1],h[2]));if(e){i(e)}}},_click:function(h,f,g){this._select(f,function(e){e.trigger("click",h,f)})},_cloneRecursive:function(g){var k,h;if(g._children.length>0){for(var f=0;f<g._children.length;f++){k=g._children[f];h=this.scene.createElement();for(var e in k){if(typeof e!="function"){h[e]=k[e]}}h.parent=g;this._cloneRecursive(k);g._children[f]=h}}},clone:function(){var f=this.scene.createElement();for(var e in this){if(typeof e!="function"){f[e]=this[e]}}this._cloneRecursive(f);return f},append:function(){var f;for(var e=0;e<arguments.length;e++){f=arguments[e];this._children.push(f);f.parent=this;f._index=this._children.length-1;f._refresh(false,true)}return arguments},prepend:function(e){this._children.push(e);e.parent=this;e.zIndex(0);return e},insertAfter:function(f){var e=f.parent.children();e.push(this);this._index=e.length-1;return this},children:function(g){var h=[],e=[];if(g){if(g instanceof Array){h=g}if(g instanceof Class){h=g.children()}for(var f=0;f<h.length;f++){e[f]=h[f].clone();e[f].parent=this}this._children=e}return this._children},detach:function(){this.remove();return this},pack:function(o,m,n){var f=this.children(),g=document.createElement("canvas"),p=g.getContext("2d"),l=this.getScene(),e;g.width=o;g.height=m;this.scene.getCanvas()._ctxTmp=p;for(var k=0;k<f.length;k++){this._children[k]._refresh(true,true)}this.scene.getCanvas()._ctxTmp=null;if(!n){this._pack=f}this.empty();e=l.createElement();e.drawImage(g);this.append(e);return this},unpack:function(){if(!this._pack){throw"Use the method pack before or impossible because you release the memory with method pack"}this._children=this._pack;this._pack=null;return this},forceEvent:function(f){if(f==undefined){f=true}this._forceEvent=f;if(!f){this.removeCmd("rect");return this}var e=this.width,g=this.height;if(!e){e=this.img.width}if(!g){g=this.img.height}if(!e||!g){throw"forceEvent() : Before, indicate the size of element !"}this.beginPath();this.rect(0,0,e,g);this.closePath();return this},isAppend:function(){return this in this.parent.children()},first:function(){return this.children()[0]},find:function(e){var g=this.children(),h=[];for(var f=0;f<g.length;f++){c=g[f];if(e==c.name){h.push(c)}}return h},findAttr:function(e,k){var h=this.children(),l,f;for(var g=0;g<h.length;g++){l=h[g];console.log(e,l.attr(e));f=l.attr(e);if(f){if(k!=undefined){if(f==k){return l}}else{return l}}}return false},zIndex:function(f){var e;if(f===undefined){return this._index}if(f instanceof Class){f=f.zIndex()}e=this.parent._children.length;if(Math.abs(f)>=e){f=-1}if(f<0){f=e+f}_CanvasEngine.moveArray(this.parent._children,this._index,f);this._index=f;this._stageRefresh();return this},zIndexBefore:function(e){this.zIndex(e.zIndex()-1);return this},remove:function(){var f;for(var e=0;e<this.parent._children.length;e++){f=this.parent._children[e];if(this._id==f._id){this.parent._children.splice(e,1);this._stageRefresh();return true}}return false},empty:function(){this._children=[];return this},attr:function(e,f){if(f===undefined){return this._attr[e]}this._attr[e]=f;return this},removeAttr:function(e){if(this._attr[e]){delete this._attr[e]}return this},offset:function(){return{left:this.x,top:this.y}},position:function(){return{left:this.real_x,top:this.real_y}},scaleTo:function(e){this.scaleX=e;this.scaleY=e;return this},css:function(m,k){var h={};var f;if(typeof m=="string"){h[m]=k}else{h=m}if(h.left){this.x=parseInt(h.left)}if(h.top){this.y=parseInt(h.top)}if(h["box-shadow"]){f=/^([0-9]+)(px)? ([0-9]+)(px)? ([0-9]+)(px)? (#[0-9a-fA-F]{6})$/.exec(h["box-shadow"]);if(f){this.shadowColor=f[7];this.shadowBlur=f[5];this.shadowOffsetX=f[1];this.shadowOffsetY=f[3]}}if(h["linear-gradient"]){f=/^\(([a-z ]+),[ ]*(.+)\)$/.exec(h["linear-gradient"]);if(f){var l=f[1];var e=f[2].split(",");this.createLinearGradient(0,0,0,0);for(var g=0;g<e.length;g++){f=/^(#[0-9a-fA-F]{6})[ ]+([0-9]{1,3})%$/.exec(e[g]);if(f){this.addColorStop(f[2]/100,f[1])}}}}if(h.opacity){this.opacity=h.opacity}this.stage.refresh();return this},hide:function(){this._visible=false},show:function(){this._visible=true},toggle:function(){if(this._visible){this.hide()}else{this.show()}},bind:function(e,f){this.on(e,f)},on:function(f,h){var g;f=f.split(" ");for(var e=0;e<f.length;e++){g=f[e];if(g=="canvas:refresh"){this.stage._onRefresh=h}else{if(g=="canvas:render"){this._onRender.push(h)}else{if(b.mobileUserAgent&&g=="click"){g="touch"}}}if(!this._listener[g]){this._listener[g]=[];this._nbEvent++}this._listener[g].push(h)}},unbind:function(e,f){this.off(e,f)},off:function(f,h){var g;f=f.split(" ");for(var e=0;e<f.length;e++){g=f[e];if(h){if(g=="canvas:render"){for(var e=0;e<this._onRender.length;e++){if(this._onRender[e]==h){this._onRender.splice(e,1);break}}}for(var e=0;e<this._listener[g].length;e++){if(this._listener[g][e]==h){this._listener[g].splice(e,1);break}}}else{if(g=="canvas:render"){this._onRender=[]}if(this._listener[g]){delete this._listener[g];this._nbEvent--}}if(this._listener[g]&&this._listener[g].length==0){delete this._listener[g];this._nbEvent--}}},eventExist:function(e){return this._listener[e]&&this._listener[e].length>0},hasEvent:function(){return this._nbEvent>0},trigger:function(k,m){var l,f=false;k=k.split(" ");if(!(m instanceof Array)){m=[m]}for(var g=0;g<k.length;g++){l=k[g];if(this._listener[l]){for(var h=0;h<this._listener[l].length;h++){f=true;if(this._listener[l][h]){this._listener[l][h].apply(this,m)}}}}return f},click:function(e){this.on("click",e)},dblclick:function(e){this.on("dblclick",e)},mouseover:function(e){this.on("mouseover",e)},mouseout:function(e){this.on("mouseout",e)},_loop:function(){for(var e=0;e<this._onRender.length;e++){if(this._onRender[e]){this._onRender[e].call(this)}}},addLoopListener:function(e){this.on("canvas:render",e)}}).extend("Context");Global_CE=b=Class["new"]("CanvasEngineClass");return b};CanvasEngine.Core=CanvasEngine;CanvasEngine.Class=Class;var CE=CanvasEngine;